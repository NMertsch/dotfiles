#!/bin/bash

# identify network devices
network_devices=$(ip -br link | cut -f1 -d" " | grep -v ^lo)
WIRELESS=$(echo $network_devices | grep -oP "w[^ ]+")
WIRED=$(echo $network_devices | grep -oP "e[^ ]+")

# ensure a primary monitor
if [ -z "$(polybar --list-monitors | grep primary)" ]; then
    first_monitor=$(polybar --list-monitors | head -n1 | cut -d":" -f1)
    xrandr --output $first_monitor --primary
fi

# kill all polybar instances
while [ -n "$(pgrep -x polybar 2>/dev/null)" ]; do
    killall polybar 2>/dev/null
    sleep 0.05
done

# launch only one polybar on given monitor
if [ ! "$1" = "" ]; then
    echo here1
    monitor="$1"
    if [ "$monitor" = $(xrandr --current | grep -o ^"$monitor") ]; then
        echo here2
        MONITOR=$monitor WIRELESS=$WIRELESS WIRED=$WIRED polybar --reload main &> /dev/null &
    else
        notify-send -u critical "polybar-launch" "Monitor '$monitor' not found"
    fi

else
    # launch polybar on every monitor seen by polybar
    for monitor_entry in $(polybar --list-monitors | tr " " "+"); do
        monitor=$(echo $monitor_entry | cut -d":" -f1)
        if [[ -n $(echo $monitor_entry | grep primary) ]]; then
            MONITOR=$monitor WIRELESS=$WIRELESS WIRED=$WIRED polybar --reload main &> /dev/null &
        else
            MONITOR=$monitor WIRELESS=$WIRELESS WIRED=$WIRED polybar --reload secondary &> /dev/null &
        fi
    done
fi
